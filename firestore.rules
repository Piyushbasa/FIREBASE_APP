
/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset prioritizes a secure, owner-centric model for user data while allowing public read access to community forum posts. User profiles and their associated data (like fields) are private and only accessible to the owning user.
 *
 * Data Structure:
 * - `/posts/{postId}`: Community forum posts, readable by all, writable only by authenticated authors.
 * - `/userProfile/{userId}`: User profiles, private to the owner.
 * - `/userProfile/{userId}/fields/{fieldId}`: User-specific fields, private to the owner.
 * - `/userProfile/{userId}/transactions/{transactionId}`: User's financial records, private to the owner.
 * - `/userProfile/{userId}/traces/{traceId}`: User's product traceability logs, private to the owner.
 *
 * Key Security Decisions:
 * - Posts are publicly readable to foster community engagement.
 * - User profiles and all subcollections are private and only accessible/modifiable by the corresponding user.
 * - Listing of user profiles is disallowed for privacy.
 * - All write operations require the `userId` or `authorId` in the resource to match the authenticated user's UID.
 *
 * Denormalization for Authorization:
 * - Posts denormalize `authorId` onto each post document to simplify ownership checks.
 * - UserField documents denormalize `userId` for the same purpose.
 * - Transaction documents denormalize `userId` for the same purpose.
 * - ProductTrace documents denormalize `userId` for the same purpose.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Defines if the user is signed in
     * @path N/A
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Defines if the user owns the resource
     * @path N/A
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Defines if the user owns the resource and the resource exists
     * @path N/A
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Security rules for the 'posts' collection.
     * @path /posts/{postId}
     */
    match /posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Security rules for the 'userProfile' collection and its subcollections.
     * @path /userProfile/{userId}
     */
    match /userProfile/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);

      /**
       * @description Security rules for the 'fields' subcollection.
       * @path /userProfile/{userId}/fields/{fieldId}
       */
      match /fields/{fieldId} {
        allow list, get: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update, delete: if isExistingOwner(userId) && resource.data.userId == userId;
      }

      /**
       * @description Security rules for the 'transactions' subcollection.
       * @path /userProfile/{userId}/transactions/{transactionId}
       */
       match /transactions/{transactionId} {
        allow list, get: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update, delete: if isExistingOwner(userId) && resource.data.userId == userId;
       }

      /**
       * @description Security rules for the 'traces' subcollection.
       * @path /userProfile/{userId}/traces/{traceId}
       */
       match /traces/{traceId} {
        allow list, get: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update, delete: if isExistingOwner(userId) && resource.data.userId == userId;
       }
    }
  }
}
